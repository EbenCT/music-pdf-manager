<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music PDF Manager</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/modules.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <!-- META TAGS PARA GOOGLE Identity Services - CSP CORREGIDA -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' 'unsafe-eval' 
            https://apis.google.com 
            https://accounts.google.com
            https://www.gstatic.com 
            https://cdnjs.cloudflare.com 
            data: blob:; 
        connect-src 'self' 
            https://www.googleapis.com 
            https://accounts.google.com
            https://oauth2.googleapis.com
            https://content.googleapis.com
            https://www.google.com; 
        frame-src 'self' 
            https://accounts.google.com 
            https://drive.google.com
            https://docs.google.com
            https://content.googleapis.com; 
        img-src 'self' data: https: blob:;
        style-src 'self' 'unsafe-inline' https:;
        font-src 'self' https: data:;
        object-src 'none';
        base-uri 'self';
    ">
    
    <!-- PRELOAD GOOGLE APIs -->
    <link rel="preconnect" href="https://apis.google.com" crossorigin>
    <link rel="preconnect" href="https://accounts.google.com" crossorigin>
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    
    <!-- Google Identity Services (GIS) - NUEVA API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Estilos adicionales para autenticaci√≥n -->
    <style>
        /* === CONNECTION STATUS PANEL === */
        .connection-status {
            background: linear-gradient(135deg, var(--dark-gray), var(--medium-gray));
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
        }

        .connection-status.hidden {
            display: none;
        }

        .status-content {
            padding: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .status-icon {
            font-size: 2.5rem;
            opacity: 0.8;
            animation: pulse 2s infinite;
        }

        .status-info {
            flex: 1;
            min-width: 200px;
        }

        .status-info h3 {
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .status-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .status-actions {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        /* === AUTH BUTTON === */
        .btn#auth-button {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: var(--white);
            border: none;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .btn#auth-button:hover {
            background: linear-gradient(135deg, #3367d6, #2d9a47);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-placeholder">üéµ</div>
                    <h1>Music PDF Manager</h1>
                </div>
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-module="visualizer">
                        üìÑ Visualizador
                    </button>
                    <button class="nav-tab" data-module="combiner">
                        üîó Combinador
                    </button>
                    <button class="nav-tab" data-module="musical">
                        üéº Musical
                    </button>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- M√≥dulo 1: Visualizador -->
            <div id="visualizer-module" class="module active">
                <div class="module-header">
                    <h2>üìÑ M√≥dulo de Visualizaci√≥n</h2>
                    <div class="search-container">
                        <input type="text" id="search-input" placeholder="üîç Buscar archivos..." class="search-input">
                        <div class="search-results" id="search-results"></div>
                    </div>
                </div>

                <!-- Panel de Estado de Conexi√≥n -->
                <div id="connection-status" class="connection-status hidden">
                    <div class="status-content">
                        <div class="status-icon">‚òÅÔ∏è</div>
                        <div class="status-info">
                            <h3 id="status-title">Conectando con Google Drive...</h3>
                            <p id="status-message">Preparando autenticaci√≥n</p>
                        </div>
                        <div class="status-actions">
                            <button id="auth-button" class="btn" style="display: none;">
                                üîê Iniciar Sesi√≥n con Google
                            </button>
                            <button id="retry-button" class="btn secondary" style="display: none;" onclick="window.app && window.app.retryConnection ? window.app.retryConnection() : location.reload()">
                                üîÑ Intentar de Nuevo
                            </button>
                        </div>
                    </div>
                </div>

                <div class="content-grid">
                    <!-- Panel Izquierdo: Listas de PDFs -->
                    <div class="pdf-lists">
                        <!-- Secci√≥n Instrumentos -->
                        <div class="pdf-section">
                            <div class="section-header">
                                <h3>üé∏ Instrumentos</h3>
                                <span class="count" id="instrumentos-count">Conectando...</span>
                            </div>
                            <div class="pdf-list" id="instrumentos-list">
                                <div class="loading">Conectando con Google Drive...</div>
                            </div>
                        </div>

                        <!-- Secci√≥n Voces -->
                        <div class="pdf-section">
                            <div class="section-header">
                                <h3>üé§ Voces</h3>
                                <span class="count" id="voces-count">Conectando...</span>
                            </div>
                            <div class="pdf-list" id="voces-list">
                                <div class="loading">Conectando con Google Drive...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Derecho: Visualizador de PDF -->
                    <div class="pdf-viewer-container">
                        <div class="viewer-header">
                            <h3 id="current-pdf-title">Conectando con Google Drive...</h3>
                            <div class="viewer-controls">
                                <button id="zoom-out" class="control-btn">üîç-</button>
                                <span id="zoom-level">100%</span>
                                <button id="zoom-in" class="control-btn">üîç+</button>
                                <button id="fullscreen" class="control-btn">‚õ∂</button>
                            </div>
                        </div>
                        <div class="pdf-viewer" id="pdf-viewer">
                            <div class="placeholder">
                                <div class="placeholder-icon">‚òÅÔ∏è</div>
                                <p>Conectando con Google Drive...</p>
                                <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: var(--spacing-md);">
                                    Se solicitar√° autorizaci√≥n para acceder a tus carpetas
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- M√≥dulo 2: Combinador (Placeholder) -->
            <div id="combiner-module" class="module">
                <div class="module-header">
                    <h2>üîó M√≥dulo de Combinaci√≥n</h2>
                </div>
                <div class="placeholder">
                    <p>M√≥dulo en desarrollo...</p>
                </div>
            </div>

            <!-- M√≥dulo 3: Musical (Placeholder) -->
            <div id="musical-module" class="module">
                <div class="module-header">
                    <h2>üéº M√≥dulo Musical Instructivo</h2>
                </div>
                <div class="placeholder">
                    <p>M√≥dulo en desarrollo...</p>
                </div>
            </div>
        </main>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Conectando con Google Drive...</p>
            </div>
        </div>
    </div>

    <!-- Scripts en ORDEN CORRECTO - CR√çTICO -->
    <script>
        // Verificar que Google Identity Services se carg√≥
        console.log('üîç Verificando Google Identity Services...');
        
        function checkGoogleIdentityServices() {
            if (typeof google !== 'undefined' && google.accounts) {
                console.log('‚úÖ Google Identity Services cargado correctamente');
                return true;
            } else {
                console.warn('‚ö†Ô∏è Google Identity Services no est√° disponible');
                return false;
            }
        }
        
        // Intentar verificar despu√©s de un delay
        setTimeout(checkGoogleIdentityServices, 1000);
    </script>
    
    <script src="config/drive-config.js"></script>
    <script src="js/drive-api-gis.js"></script>
    <script src="js/pdf-viewer.js"></script>
    <script src="js/search.js"></script>
    <script src="js/main.js"></script>
    
    <script>
        // Debug script para verificar carga de archivos
        window.addEventListener('load', function() {
            console.log('üîç Verificando carga de scripts...');
            console.log('üìä ConfigUtils:', typeof ConfigUtils !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('üìä DriveAPIGIS:', typeof DriveAPIGIS !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('üìä PDFViewer:', typeof PDFViewer !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('üìä SearchManager:', typeof SearchManager !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('üìä Google Identity:', typeof google !== 'undefined' && google.accounts ? '‚úÖ' : '‚ùå');
        });
    </script>
</body>
</html>