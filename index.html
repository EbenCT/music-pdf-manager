<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music PDF Manager</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/modules.css">
    <link rel="stylesheet" href="css/combiner.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <!-- META TAGS PARA GOOGLE Identity Services -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' 'unsafe-eval' 
            https://apis.google.com 
            https://accounts.google.com
            https://www.gstatic.com 
            https://cdnjs.cloudflare.com 
            data: blob:; 
        connect-src 'self' 
            https://www.googleapis.com 
            https://accounts.google.com
            https://oauth2.googleapis.com
            https://content.googleapis.com
            https://www.google.com
            https://drive.google.com
            https://lh3.googleusercontent.com
            blob: data:; 
        frame-src 'self' 
            https://accounts.google.com 
            https://drive.google.com
            https://docs.google.com
            https://content.googleapis.com; 
        img-src 'self' data: https: blob:;
        style-src 'self' 'unsafe-inline' https:;
        font-src 'self' https: data:;
        object-src 'none';
        base-uri 'self';
    ">
    
    <!-- PRELOAD GOOGLE APIs -->
    <link rel="preconnect" href="https://apis.google.com" crossorigin>
    <link rel="preconnect" href="https://accounts.google.com" crossorigin>
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://drive.google.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- PDF-lib para combinaciÃ³n de PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    
    <!-- Estilos adicionales para autenticaciÃ³n -->
    <style>
        .auth-status {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--dark-gray);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            margin-left: var(--spacing-md);
        }

        .auth-status.authenticated {
            background: linear-gradient(135deg, #34a853, #2d9a47);
            color: white;
        }

        .auth-status.not-authenticated {
            background: var(--accent-red);
            color: white;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-placeholder">ğŸµ</div>
                    <h1>Music PDF Manager</h1>
                    <div id="auth-status" class="auth-status">
                        <span id="auth-icon">ğŸ”„</span>
                        <span id="auth-text">Conectando...</span>
                    </div>
                </div>
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-module="visualizer">
                        ğŸ“„ Visualizador
                    </button>
                    <button class="nav-tab" data-module="combiner">
                        ğŸ”— Combinador
                    </button>
                    <button class="nav-tab" data-module="musical">
                        ğŸ¼ Musical
                    </button>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- MÃ³dulo 1: Visualizador -->
            <div id="visualizer-module" class="module active">
                <div class="module-header">
                    <h2>ğŸ“„ MÃ³dulo de VisualizaciÃ³n</h2>
                    <div class="search-container">
                        <input type="text" id="search-input" placeholder="ğŸ” Buscar archivos..." class="search-input">
                        <div class="search-results" id="search-results"></div>
                    </div>
                </div>

                <!-- Panel de Estado de ConexiÃ³n -->
                <div id="connection-status" class="connection-status hidden">
                    <div class="status-content">
                        <div class="status-icon">â˜ï¸</div>
                        <div class="status-info">
                            <h3 id="status-title">Conectando con Google Drive...</h3>
                            <p id="status-message">Preparando autenticaciÃ³n</p>
                        </div>
                        <div class="status-actions">
                            <button id="auth-button" class="btn" style="display: none;">
                                ğŸ” Iniciar SesiÃ³n con Google
                            </button>
                            <button id="retry-button" class="btn secondary" style="display: none;" onclick="window.app && window.app.retryConnection ? window.app.retryConnection() : location.reload()">
                                ğŸ”„ Intentar de Nuevo
                            </button>
                            <button id="logout-button" class="btn secondary" style="display: none;" onclick="window.app && window.app.signOut ? window.app.signOut() : console.log('Logout no disponible')">
                                ğŸ‘‹ Cerrar SesiÃ³n
                            </button>
                        </div>
                    </div>
                </div>

                <div class="content-grid">
                    <!-- Panel Izquierdo: Listas de PDFs -->
                    <div class="pdf-lists">
                        <!-- SecciÃ³n Instrumentos -->
                        <div class="pdf-section">
                            <div class="section-header">
                                <h3>ğŸ¸ Instrumentos</h3>
                                <span class="count" id="instrumentos-count">Conectando...</span>
                            </div>
                            <div class="pdf-list" id="instrumentos-list">
                                <div class="loading">Conectando con Google Drive...</div>
                            </div>
                        </div>

                        <!-- SecciÃ³n Voces -->
                        <div class="pdf-section">
                            <div class="section-header">
                                <h3>ğŸ¤ Voces</h3>
                                <span class="count" id="voces-count">Conectando...</span>
                            </div>
                            <div class="pdf-list" id="voces-list">
                                <div class="loading">Conectando con Google Drive...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Derecho: Visualizador de PDF -->
                    <div class="pdf-viewer-container">
                        <div class="viewer-header">
                            <h3 id="current-pdf-title">Conectando con Google Drive...</h3>
                            <div class="viewer-controls">
                                <button id="zoom-out" class="control-btn">ğŸ”-</button>
                                <span id="zoom-level">100%</span>
                                <button id="zoom-in" class="control-btn">ğŸ”+</button>
                                <button id="fullscreen" class="control-btn">â›¶</button>
                                <button id="download-pdf" class="control-btn" title="Descargar PDF">ğŸ“¥</button>
                            </div>
                        </div>
                        <div class="pdf-viewer" id="pdf-viewer">
                            <div class="placeholder">
                                <div class="placeholder-icon">â˜ï¸</div>
                                <p>Conectando con Google Drive...</p>
                                <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: var(--spacing-md);">
                                    Se solicitarÃ¡ autorizaciÃ³n para acceder a tus carpetas
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MÃ³dulo 2: Combinador (Placeholder) -->
            <div id="combiner-module" class="module">
                <div class="module-header">
                    <h2>ğŸ”— MÃ³dulo de CombinaciÃ³n</h2>
                </div>
                <div class="placeholder">
                    <p>MÃ³dulo en desarrollo...</p>
                </div>
            </div>

            <!-- MÃ³dulo 3: Musical (Placeholder) -->
            <div id="musical-module" class="module">
                <div class="module-header">
                    <h2>ğŸ¼ MÃ³dulo Musical Instructivo</h2>
                </div>
                <div class="placeholder">
                    <p>MÃ³dulo en desarrollo...</p>
                </div>
            </div>
        </main>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Conectando con Google Drive...</p>
            </div>
        </div>
    </div>

    <!-- Scripts en ORDEN CORRECTO -->
    <script>
        // Verificar que Google Identity Services se cargÃ³
        console.log('ğŸ” Verificando Google Identity Services...');
        
        function checkGoogleIdentityServices() {
            if (typeof google !== 'undefined' && google.accounts) {
                console.log('âœ… Google Identity Services cargado correctamente');
                return true;
            } else {
                console.warn('âš ï¸ Google Identity Services no estÃ¡ disponible');
                return false;
            }
        }
        
        // Intentar verificar despuÃ©s de un delay
        setTimeout(checkGoogleIdentityServices, 1000);
    </script>
    
    <!-- 1. ConfiguraciÃ³n -->
    <script src="config/drive-config.js"></script>
    
    <!-- 2. MÃ³dulos de Drive (orden importante) -->
    <script src="js/drive-utils.js"></script>
    <script src="js/drive-auth.js"></script>
    <script src="js/drive-files.js"></script>
    <script src="js/drive-api.js"></script>
    
    <!-- 3. Otros mÃ³dulos -->
    <script src="js/pdf-viewer.js"></script>
    <script src="js/search-utils.js"></script>
    <script src="js/search.js"></script>
    <script src="js/pdf-combiner-real.js"></script>
    <script src="js/combiner.js"></script>
    <script src="js/main.js"></script>
    
    <script>
        // Debug script para verificar carga de archivos
        window.addEventListener('load', function() {
            console.log('ğŸ” Verificando carga de scripts...');
            console.log('ğŸ“Š ConfigUtils:', typeof ConfigUtils !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('ğŸ“Š DriveUtils:', typeof DriveUtils !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('ğŸ“Š DriveAuth:', typeof DriveAuth !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('ğŸ“Š DriveFiles:', typeof DriveFiles !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('ğŸ“Š DriveAPIGIS:', typeof DriveAPIGIS !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('ğŸ“Š PDFViewer:', typeof PDFViewer !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('ğŸ“Š SearchUtils:', typeof SearchUtils !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('ğŸ“Š SearchManager:', typeof SearchManager !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('ğŸ“Š CombinerModule:', typeof CombinerModule !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('ğŸ“Š Google Identity:', typeof google !== 'undefined' && google.accounts ? 'âœ…' : 'âŒ');
        });
    </script>
</body>
</html>